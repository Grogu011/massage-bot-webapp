<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏–µ–º - –ú–∞—Å—Å–∞–∂ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #4a5568;
            font-size: 24px;
        }
        
        h2 {
            margin: 15px 0 10px 0;
            color: #2d3748;
            font-size: 18px;
        }
        
        .step {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .step.active {
            display: block;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-back {
            background: #718096;
            margin-top: 15px;
        }
        
        .btn-back:hover {
            background: #4a5568;
            transform: translateY(-2px);
        }
        
        .procedure-type {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .procedure-type:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }
        
        .procedure-type.selected {
            background: #ebf4ff;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .procedure-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .procedure-item:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }
        
        .procedure-item.selected {
            background: #ebf4ff;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .price {
            color: #667eea;
            font-weight: 600;
            font-size: 16px;
            margin-top: 5px;
        }
        
        .duration {
            color: #718096;
            font-size: 14px;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 15px 0;
        }
        
        .calendar-day {
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            background: #f7fafc;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #edf2f7;
            transform: scale(1.05);
        }
        
        .calendar-day.selected {
            background: #667eea;
            color: white;
            border-color: #553c9a;
        }
        
        .calendar-day.weekend {
            background: #fed7d7;
            color: #c53030;
        }
        
        .calendar-day.disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        
        .time-slot {
            padding: 15px;
            margin: 8px 0;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .time-slot:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }
        
        .time-slot.selected {
            background: #667eea;
            color: white;
            border-color: #553c9a;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .time-slot.disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        
        .confirmation-card {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #e2e8f0;
        }
        
        .confirmation-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .confirmation-label {
            color: #718096;
            font-weight: 500;
        }
        
        .confirmation-value {
            color: #2d3748;
            font-weight: 600;
        }
        
        .total-price {
            font-size: 20px;
            color: #667eea;
            font-weight: 700;
            text-align: center;
            margin: 15px 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã -->
        <div class="step active" id="step1">
            <h1>üéØ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ—Ü–µ–¥—É—Ä—ã</h1>
            
            <div class="procedure-type" onclick="selectProcedureType('massage')">
                <h2>üíÜ‚Äç‚ôÇÔ∏è –ú–∞—Å—Å–∞–∂</h2>
                <p>–†–∞—Å—Å–ª–∞–±–ª—è—é—â–∏–µ –∏ –ª–µ—á–µ–±–Ω—ã–µ –º–∞—Å—Å–∞–∂–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã</p>
            </div>
            
            <div class="procedure-type" onclick="selectProcedureType('injections')">
                <h2>üíâ –£–∫–æ–ª—ã</h2>
                <p>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏–Ω—ä–µ–∫—Ü–∏–∏ –∏ —Ç–µ—Ä–∞–ø–∏—è</p>
            </div>
            
            <div class="procedure-type" onclick="selectProcedureType('hirudotherapy')">
                <h2>üêç –ì–∏—Ä—É–¥–æ—Ç–µ—Ä–∞–ø–∏—è</h2>
                <p>–õ–µ—á–µ–Ω–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ –ø–∏—è–≤–∫–∞–º–∏</p>
            </div>
        </div>

        <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã -->
        <div class="step" id="step2">
            <h1>üìã –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É</h1>
            <div id="proceduresList"></div>
            <button class="btn btn-back" onclick="goToStep(1)">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <!-- –®–∞–≥ 3: –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
        <div class="step" id="step3">
            <h1>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h1>
            <div id="calendar"></div>
            <button class="btn btn-back" onclick="goToStep(2)">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <!-- –®–∞–≥ 4: –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ -->
        <div class="step" id="step4">
            <h1>‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</h1>
            <div id="timeSlots"></div>
            <button class="btn btn-back" onclick="goToStep(3)">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <!-- –®–∞–≥ 5: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -->
        <div class="step" id="step5">
            <h1>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h1>
            <div class="confirmation-card">
                <div class="confirmation-item">
                    <span class="confirmation-label">–ü—Ä–æ—Ü–µ–¥—É—Ä–∞:</span>
                    <span class="confirmation-value" id="confirmProcedure"></span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">–î–∞—Ç–∞:</span>
                    <span class="confirmation-value" id="confirmDate"></span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">–í—Ä–µ–º—è:</span>
                    <span class="confirmation-value" id="confirmTime"></span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span>
                    <span class="confirmation-value" id="confirmDuration"></span>
                </div>
            </div>
            
            <div class="total-price" id="confirmPrice"></div>
            
            <button class="btn" onclick="confirmAppointment()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
            <button class="btn btn-back" onclick="goToStep(4)">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <!-- –®–∞–≥ 6: –£—Å–ø–µ—Ö -->
        <div class="step" id="step6">
            <h1>üéâ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!</h1>
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 60px; margin-bottom: 20px;">‚úÖ</div>
                <p>–í–∞—à–∞ –∑–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</p>
                <p>–ú—ã –∂–¥–µ–º –≤–∞—Å –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è.</p>
                <p>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–∏–¥–µ—Ç –∑–∞ –¥–µ–Ω—å –¥–æ –≤–∏–∑–∏—Ç–∞.</p>
            </div>
            <button class="btn" onclick="closeWebApp()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä
        const procedureData = {
            'massage': [
                { id: 1, name: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂', price: 1000, duration: '60 –º–∏–Ω—É—Ç', description: '–†–∞—Å—Å–ª–∞–±–ª—è—é—â–∏–π –æ–±—â–∏–π –º–∞—Å—Å–∞–∂ –≤—Å–µ–≥–æ —Ç–µ–ª–∞' },
                { id: 2, name: '–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –º–∞—Å—Å–∞–∂', price: 1500, duration: '90 –º–∏–Ω—É—Ç', description: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π –º–∞—Å—Å–∞–∂ –¥–ª—è —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤' },
                { id: 3, name: '–†–∞—Å—Å–ª–∞–±–ª—è—é—â–∏–π –º–∞—Å—Å–∞–∂', price: 1200, duration: '60 –º–∏–Ω—É—Ç', description: '–ù–µ–∂–Ω—ã–π –º–∞—Å—Å–∞–∂ –¥–ª—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏' },
                { id: 4, name: '–õ–µ—á–µ–±–Ω—ã–π –º–∞—Å—Å–∞–∂', price: 1800, duration: '75 –º–∏–Ω—É—Ç', description: '–ú–∞—Å—Å–∞–∂ –¥–ª—è –ª–µ—á–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å–æ —Å–ø–∏–Ω–æ–π' }
            ],
            'injections': [
                { id: 5, name: '–û–∑–æ–Ω–æ—Ç–µ—Ä–∞–ø–∏—è', price: 2000, duration: '30 –º–∏–Ω—É—Ç', description: '–õ–µ—á–µ–Ω–∏–µ –æ–∑–æ–Ω–æ–º' },
                { id: 6, name: '–ú–µ–∑–æ—Ç–µ—Ä–∞–ø–∏—è', price: 2500, duration: '45 –º–∏–Ω—É—Ç', description: '–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—ä–µ–∫—Ü–∏–∏' },
                { id: 7, name: '–í–∏—Ç–∞–º–∏–Ω–Ω—ã–µ –∫–∞–ø–µ–ª—å–Ω–∏—Ü—ã', price: 3000, duration: '60 –º–∏–Ω—É—Ç', description: '–í–Ω—É—Ç—Ä–∏–≤–µ–Ω–Ω—ã–µ –≤–∏—Ç–∞–º–∏–Ω–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã' }
            ],
            'hirudotherapy': [
                { id: 8, name: '–ì–∏—Ä—É–¥–æ—Ç–µ—Ä–∞–ø–∏—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)', price: 1800, duration: '60 –º–∏–Ω—É—Ç', description: '–õ–µ—á–µ–Ω–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ –ø–∏—è–≤–∫–∞–º–∏' },
                { id: 9, name: '–ì–∏—Ä—É–¥–æ—Ç–µ—Ä–∞–ø–∏—è (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è)', price: 2500, duration: '90 –º–∏–Ω—É—Ç', description: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–µ–∞–Ω—Å –≥–∏—Ä—É–¥–æ—Ç–µ—Ä–∞–ø–∏–∏' }
            ]
        };

        // –¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let currentSelection = {
            procedureType: null,
            procedure: null,
            date: null,
            time: null
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function goToStep(stepNumber) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —à–∞–≥
            document.getElementById('step' + stepNumber).classList.add('active');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —à–∞–≥–∞
            loadStepData(stepNumber);
        }

        function loadStepData(stepNumber) {
            switch(stepNumber) {
                case 2:
                    loadProcedures();
                    break;
                case 3:
                    loadCalendar();
                    break;
                case 4:
                    loadTimeSlots();
                    break;
                case 5:
                    showConfirmation();
                    break;
            }
        }

        function selectProcedureType(type) {
            currentSelection.procedureType = type;
            goToStep(2);
        }

        function loadProcedures() {
            const procedures = procedureData[currentSelection.procedureType];
            const container = document.getElementById('proceduresList');
            
            container.innerHTML = '';
            procedures.forEach(proc => {
                container.innerHTML += `
                    <div class="procedure-item" onclick="selectProcedure(${proc.id})">
                        <h3>${proc.name}</h3>
                        <p>${proc.description}</p>
                        <div class="price">üí∞ ${proc.price} —Ä—É–±</div>
                        <div class="duration">‚è∞ ${proc.duration}</div>
                    </div>
                `;
            });
        }

        function selectProcedure(procId) {
            const procedures = procedureData[currentSelection.procedureType];
            currentSelection.procedure = procedures.find(p => p.id === procId);
            goToStep(3);
        }

        function loadCalendar() {
            const calendar = document.getElementById('calendar');
            const today = new Date();
            
            // –ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π
            let calendarHTML = '<div class="calendar">';
            
            for (let i = 0; i < 30; i++) {
                const date = new Date();
                date.setDate(today.getDate() + i);
                
                const day = date.getDate();
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                const dayOfWeek = date.getDay();
                
                const dateString = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = i === 0;
                
                calendarHTML += `
                    <div class="calendar-day ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}" 
                         onclick="selectDate('${dateString}')">
                        ${day}
                    </div>
                `;
            }
            
            calendarHTML += '</div>';
            calendar.innerHTML = calendarHTML;
        }

        function selectDate(date) {
            currentSelection.date = date;
            goToStep(4);
        }

        function loadTimeSlots() {
            const timeSlots = document.getElementById('timeSlots');
            const times = ['10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
            
            timeSlots.innerHTML = '';
            times.forEach(time => {
                timeSlots.innerHTML += `
                    <div class="time-slot" onclick="selectTime('${time}')">
                        ${time}
                    </div>
                `;
            });
        }

        function selectTime(time) {
            currentSelection.time = time;
            goToStep(5);
        }

        function showConfirmation() {
            document.getElementById('confirmProcedure').textContent = currentSelection.procedure.name;
            document.getElementById('confirmDate').textContent = formatDate(currentSelection.date);
            document.getElementById('confirmTime').textContent = currentSelection.time;
            document.getElementById('confirmDuration').textContent = currentSelection.procedure.duration;
            document.getElementById('confirmPrice').textContent = `–ò—Ç–æ–≥–æ: ${currentSelection.procedure.price} —Ä—É–±`;
        }

        function formatDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}.${month}.${year}`;
        }

        function confirmAppointment() {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            console.log('–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞:', currentSelection);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
            goToStep(6);
            
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç–∞
            // Telegram.WebApp.sendData(JSON.stringify(currentSelection));
        }

        function closeWebApp() {
            Telegram.WebApp.close();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        console.log('WebApp –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø—Ä–∏–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω!');
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
async function loadProceduresFromAPI() {
    try {
        const response = await fetch('/api/procedures/massage');
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä');
        return await response.json();
    } catch (error) {
        console.error('Error loading procedures:', error);
        return procedureData; // fallback to local data
    }
}

async function createAppointmentAPI(appointmentData) {
    try {
        const response = await fetch('/api/appointments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(appointmentData)
        });
        
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏');
        return await response.json();
    } catch (error) {
        console.error('Error creating appointment:', error);
        throw error;
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é confirmAppointment
async function confirmAppointment() {
    try {
        const appointmentData = {
            procedure_id: currentSelection.procedure.id,
            appointment_date: `${currentSelection.date}T${currentSelection.time}:00`,
            user: {
                telegram_id: Telegram.WebApp.initDataUnsafe.user.id,
                username: Telegram.WebApp.initDataUnsafe.user.username,
                first_name: Telegram.WebApp.initDataUnsafe.user.first_name
            }
        };
        
        const result = await createAppointmentAPI(appointmentData);
        console.log('–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞:', result);
        
        goToStep(6);
        
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        console.error('Appointment error:', error);
    }
}
    </script>
</body>
</html>
